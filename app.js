// ------------------------------------------------------------
// app.jsï¼ˆã‚¢ãƒ—ãƒªã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰
// Express ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ãƒ»ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®šãƒ»ãƒ«ãƒ¼ãƒˆèª­è¾¼ã‚’è¡Œã†
// REST APIã€€ã®è€ƒãˆæ–¹ã‚’ç”¨ã„ã¦ã„ã‚‹
// ------------------------------------------------------------

// Expressãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’èª­ã¿è¾¼ã‚€ï¼ˆHTTP ã‚µãƒ¼ãƒãƒ¼ã‚’ç°¡å˜ã«ä½œã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
const express = require("express");

// CORSï¼ˆåˆ¥ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ä»•çµ„ã¿ï¼‰ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’èª­ã¿è¾¼ã‚€
// Swiftã‚¢ãƒ—ãƒªï¼ˆiOS â†’ http://xx.xx.xx.xx:3000ï¼‰ã¨APIã‚µãƒ¼ãƒãƒ¼ã®é€šä¿¡ã«å¿…è¦
const cors = require("cors");

const http = require("http");        // â† è¿½åŠ ï¼šWebSocketã¨Expressã‚’åŒã˜ã‚µãƒ¼ãƒãƒ¼ã§å‹•ã‹ã™
const WebSocket = require("ws");     // â† è¿½åŠ 


// ------------------------------------------------------------
//  ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿
//  ./routes/auth.js
//  ./routes/messages.js
//  ./routes/rooms.js
//  ã‚’èª­ã¿è¾¼ã‚€
//  Expressã® "app.use()" ã§URLãƒ‘ã‚¹ã«å‰²ã‚Šå½“ã¦ã‚‹
// ------------------------------------------------------------
const authRoutes = require("./routes/auth");         // ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç³»
const messageRoutes = require("./routes/messages");  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ãƒ»é€ä¿¡
const roomRoutes = require("./routes/rooms");        // ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ å–å¾—ãªã©

// ------------------------------------------------------------
// Expressã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ
// ------------------------------------------------------------
const app = express();

// ------------------------------------------------------------
// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®š
// ------------------------------------------------------------

// JSONå½¢å¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’è‡ªå‹•ã§è§£æã™ã‚‹
// Swiftã®URLRequestã§é€ã‚‹JSONã‚’ "req.body" ã«å±•é–‹ã—ã¦ãã‚Œã‚‹
app.use(express.json());

// CORSã‚’è¨±å¯ã™ã‚‹ï¼ˆiOSã‚¢ãƒ—ãƒªã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿…è¦ï¼‰
app.use(cors());

// ------------------------------------------------------------
// ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’URLãƒ‘ã‚¹ã«ç´ã¥ã‘ã‚‹
// ------------------------------------------------------------

// /auth/login â†’ authRoutes å†…ã® POST /login ãŒå‘¼ã°ã‚Œã‚‹
// /auth/register ãªã©ã‚‚ã“ã“ã§æ‰±ãˆã‚‹
app.use("/auth", authRoutes);

// /messages/... â†’ messagesRoutes å†…ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå‘¼ã°ã‚Œã‚‹
app.use("/messages", messageRoutes);

// /rooms/... â†’ roomRoutes å†…ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå‘¼ã°ã‚Œã‚‹
app.use("/rooms", roomRoutes);

// ------------------------------------------------------------
// HTTP ã‚µãƒ¼ãƒãƒ¼ä½œæˆï¼ˆExpress + WebSocket å…±æœ‰ï¼‰
// ------------------------------------------------------------
const server = http.createServer(app);

// ------------------------------------------------------------
// WebSocket ã‚µãƒ¼ãƒãƒ¼ä½œæˆ
// ------------------------------------------------------------
const wss = new WebSocket.Server({ server });

// ã™ã¹ã¦ã®æ¥ç¶šã‚’ç®¡ç†
let clients = [];

// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆ
wss.on("connection", (ws) => {
  console.log("ğŸ”Œ Client connected");
  clients.push(ws);

  ws.on("close", () => {
    console.log("âŒ Client disconnected");
    clients = clients.filter(c => c !== ws);
  });
});

// ------------------------------------------------------------
// WebSocket ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°ã‚’é€šçŸ¥ã™ã‚‹é–¢æ•°
// ------------------------------------------------------------
function broadcastMessageUpdate(roomId) {
  const payload = JSON.stringify({
    type: "update",
    roomId: roomId
  });

  clients.forEach(ws => {
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(payload);
    }
  });
}
// ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã« export
module.exports.broadcastMessageUpdate = broadcastMessageUpdate;

// ------------------------------------------------------------
// ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒ¼ãƒˆ3000ã§èµ·å‹•
// ------------------------------------------------------------
const PORT = 3000;

app.listen(PORT, () => {
  console.log(`API is running on port ${PORT}`);
  // http://16.176.165.34:3000 ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
});